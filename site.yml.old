---
- hosts: localhost
  connection: local
  gather_facts: no
  vars:
    ssh_key_name: "{{ lookup('env', 'USER') }}"
    ssh_key_path: "{{ lookup('env', 'HOME') }}/.ssh/id_rsa.pub"
    do_client_id: "{{ lookup('env', 'DO_CLIENT_ID') }}"
    do_api_key: "{{ lookup('env', 'DO_API_KEY') }}"
  vars_files:
    - digital_ocean_vars.yml

  tasks:
    - digital_ocean: >
        state=present
        command=ssh
        name="{{ ssh_key_name }}"
        ssh_pub_key="{{ lookup('file', ssh_key_path) }}"
        client_id="{{ do_client_id }}"
        api_key="{{ do_api_key }}"
      register: do

    - digital_ocean: >
        state=present
        unique_name=yes
        name="{{ item }}"
        ssh_key_ids="{{ do.ssh_key.id }}"
        client_id="{{ do_client_id }}"
        api_key="{{ do_api_key }}"
        size_id="{{ vars[hostvars[item].size] }}"
        region_id="{{ vars[hostvars[item].region] }}"
        image_id="{{ vars[hostvars[item].image] }}"
      with_items: groups.droplets
      register: do

    - add_host: >
        name="{{ item.droplet.name }}"
        ansible_ssh_host="{{ item.droplet.ip_address }}"
        groups=droplets
      with_items: do.results

    - add_host: >
        name="{{ item.droplet.ip_address }}"
        groups=unnamed_droplets
      with_items: do.results

    - add_host: >
        name="{{ item.droplet.ip_address }}"
        groups=unnamed_dns_servers
      when: item.droplet.name in groups.dns_servers
      with_items: do.results

    - add_host: >
        name="{{ item.droplet.ip_address }}"
        groups=unnamed_proxy_servers
      when: item.droplet.name in groups.proxy_servers
      with_items: do.results

    - add_host: >
        name="{{ item.droplet.ip_address }}"
        groups=unnamed_docker_servers
      when: item.droplet.name in groups.docker_servers
      with_items: do.results

    - add_host: >
        name="{{ item.droplet.ip_address }}"
        groups=unnamed_mongo_servers
      when: item.droplet.name in groups.mongo_servers
      with_items: do.results

- hosts: unnamed_droplets
  remote_user: root
  roles:
  - role: common

- hosts: unnamed_dns_servers
  remote_user: root
  vars:
    timestamp: "{{ lookup('pipe', 'date +%s') }}"
  vars_files:
  - domains.yml
  roles:
  - role: dns

- hosts: unnamed_proxy_servers
  remote_user: root
  roles:
  - role: proxy

- hosts: unnamed_docker_servers
  remote_user: root
  roles:
  - role: docker

- hosts: unnamed_mongo_servers
  remote_user: root
  roles:
  - role: mongod
